// ***********************************************************************
//
// Demo program for education in subject
// Computer Architectures and Parallel Systems.
// Petr Olivka, dep. of Computer Science, FEI, VSB-TU Ostrava
// email:petr.olivka@vsb.cz
//
// Example of CUDA Technology Usage with unified memory.
//
// Image transformation from RGB to BW schema. 
// Image manipulation is performed by OpenCV library. 
//
// ***********************************************************************

#include <stdio.h>
#include <cuda_device_runtime_api.h>
#include <cuda_runtime.h>
#include "opencv2/opencv.hpp"
#include "pic_type.h"
#include "uni_mem_allocator.h"

using namespace cv;

// Function prototype from .cu file
void cu_run_grayscale( CUDA_Pic bgr_pic, CUDA_Pic bw_pic );
void cu_run_rotate(CUDA_Pic original,CUDA_Pic rotated,int rotationnum);
void cu_run_shrink(CUDA_Pic orig,CUDA_Pic shrunk,int widthheight);


int main( int numarg, char **arg )
{
	int shrunkby = 1;
	// Uniform Memory allocator for Mat
	UniformAllocator allocator;
	cv::Mat::setDefaultAllocator( &allocator );

	if ( numarg < 2 ) 
	{
		printf( "Enter picture filename!\n" );
		return 1;
	}

	// Load image
	Mat cv_bgr = imread( arg[ 1 ], CV_LOAD_IMAGE_COLOR );

	if ( !cv_bgr.data )
	{
		printf( "Unable to read file '%s'\n", arg[ 1 ] );
		return 1;
	}

	// create empty BW image
	Mat cv_bw( cv_bgr.size(), CV_8UC3 );
	Mat cv_rot(cv_bgr.cols,cv_bgr.rows,CV_8UC3 );
	int shrunkcols = cv_bgr.cols,shrunkrows=cv_bgr.rows;
	switch(shrunkby)
	{

			case 1:
			{
				shrunkcols/=2;
				break;
			}
			case 2:
			{
				shrunkrows/=2;
				break;
			}
			case 3:
			{
				shrunkcols/=2;
				shrunkrows/=2;
				break;
			}
			default:break;

	}


	Mat cv_shrunk(shrunkcols,shrunkrows,CV_8UC3 );


	// data for CUDA
	CUDA_Pic pic_bgr, pic_bw,pic_rot,pic_shr;
	/*pic_bgr.Size.x = pic_bw.Size.x = cv_bgr.size().width;
	pic_bgr.Size.y = pic_bw.Size.y = cv_bgr.size().height;
	pic_bgr.P_uchar3 = ( uchar3 * ) cv_bgr.data;
	pic_bw.P_uchar3 = ( uchar3 * ) cv_bw.data;
	*/
	pic_bgr.setMat(cv_bgr);
	pic_bw.setMat(cv_bw);
	pic_rot.setMat(cv_rot);
	pic_shr.setMat(cv_shrunk);

	// Function calling from .cu file
	cu_run_grayscale( pic_bgr, pic_bw );
	cu_run_rotate(pic_bgr,pic_rot,3);
	cu_run_shrink(pic_bgr,pic_shr,1);

	// Show the Color and BW image
	imshow( "Color", cv_bgr );
	imshow( "GrayScale", cv_bw );
	imshow( "Rotated", cv_rot );
	imshow( "Shrunk", cv_shrunk );

	waitKey( 0 );
}

